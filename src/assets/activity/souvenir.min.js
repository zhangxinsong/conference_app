(function(){var e={basePath:"https://fast.yonyou.com/30years_service"};function s(e){this.basePath=e.basePath;this.xhr=null;this.file=null;this.commitTimer=null;this.userInfo=null;this.size="";this.sizeDesc="";this.code=this.getQueryString().code;this.hasComAuth=true;this.avatarUrl="";this.rangeArr=["0001AB1000000006AR1F","0001UC100000000FCDCN","0001AB1000000006AR16","0001AB1000000006AR17","0001AB1000000006AR1G"]}s.prototype={init:function(){this.createAjax();if(this.code){this.getUserInfo()}else{this.getBridgeCode()}this.events()},nodes:{$toash:$(".toast-msg"),$fileImage:$("#fileImage"),$loading:$(".loading-wrapper"),$submit:$(".btn-cmt"),$clothes:$(".clothes .size"),$sizeInput:$(".size .size-input"),$clear:$(".size .clear"),$avatar:$(".lf-logo")},createAjax:function(){this.xhr=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},getQueryString:function(){var e=window.location.search.length>0?window.location.search.substring(1):"",s=e.length?e.split("&"):[],t=[],i={};s.forEach(function(e,s){t=e.split("=");if(decodeURIComponent(t[0]).length){i[t[0]]=decodeURIComponent(t[1])}});return i},connectJSBridge:function(e){var s=this;if(window.WebViewJavascriptBridge){if(!s.initBridge){s.initBridge=true;window.WebViewJavascriptBridge.init()}e(window.WebViewJavascriptBridge)}else{document.addEventListener("WebViewJavascriptBridgeReady",function(){if(!s.initBridge){s.initBridge=true;window.WebViewJavascriptBridge.init()}e(window.WebViewJavascriptBridge)},false)}},getBridgeCode:function(){var t=this;t.connectJSBridge(function(e){var s={function:"getAppCode"};e.send(JSON.stringify(s),function(e){var s=JSON.parse(e);if(s&&s.error_code==0){t.code=s.data.code;t.getUserInfo()}else{t.showToast("获取用户信息失败！")}})})},ajax:function(e){var s=this;var t=["application/json","multipart/form-data","application/x-www-form-urlencoded"];var i=e.type&&e.type.toLowerCase()||"get",n=e.data||null,o=e.contentType||"application/json",a=this.basePath+(e.url||"");if(n){switch(t.indexOf(o)){case 1:{var r=new FormData;(function e(s){for(var t in s){if(s[t]instanceof Array){e(s[t])}else{r.append(t,s[t])}}})(n);n=r;break}case 2:{var d=[];for(var c in n){d.push(c,n[c])}n=d.join("&");break}default:{n=JSON.stringify(n);break}}}this.xhr.open(i,a,true);if(o!=="multipart/form-data"){this.xhr.setRequestHeader("Content-type",o)}this.xhr.send(n);this.xhr.onreadystatechange=function(){if(s.xhr.readyState===4){if(s.xhr.status===200){e.success&&e.success(JSON.parse(s.xhr.responseText))}else{e.error&&e.error(JSON.parse(s.xhr.responseText))}}};this.xhr.onerror=function(){e.error&&e.error(s.xhr.responseText)}},getUserInfo:function(){var s=this;if(s.code){this.ajax({type:"get",url:"/public/get_info?esncode="+s.code,success:function(e){if(e.code==0){s.userInfo=e&&e.data||{};if(s.rangeArr.indexOf(s.userInfo.PK_PSNCL)<0){s.showToast("非常抱歉，您不能参加此活动 。",3e3);s.nodes.$submit.addClass("submitted");s.hasComAuth=false}else{if(s.userInfo.psn_info){s.userInfo.psn_info.imgUrl&&s.backAvatar(s.userInfo.psn_info.imgUrl);(s.userInfo.psn_info.clothSize||s.userInfo.psn_info.ext1)&&s.backSize(s.userInfo.psn_info.clothSize,s.userInfo.psn_info.ext1)}}}else{s.showToast(e.msg||"获取用户信息失败！")}},error:function(e){s.showToast("网络错误，请稍后重试！")}})}else{s.showToast("获取用户信息失败！")}},backAvatar:function(e){var s=this;s.avatarUrl=s.basePath+"/download/30years/"+e;s.nodes.$avatar.addClass("selected").css({"background-image":"url("+s.avatarUrl+")"})},backSize:function(s,e){var t=this;s&&t.nodes.$clothes.children().forEach(function(e){if($(e).text().toLocaleUpperCase()===s.toLocaleUpperCase()){$(e).addClass("selected")}});e&&t.nodes.$clothes.find(".size-input").val(e)},submit:function(){var s=this;if(s.code){var e={clothSize:s.size,height:"",weight:"",ext1:s.sizeDesc};s.file&&(e.headImg=s.file);this.ajax({type:"post",url:"/upload/post_file?user="+s.userInfo.tys_user+"&expired="+s.userInfo.tys_expired+"&sign="+s.userInfo.tys_sign,contentType:"multipart/form-data",data:e,success:function(e){if(e.code==0){s.nodes.$loading.css("opacity",0).addClass("hidden");s.showToast("提交成功！");s.nodes.$submit.text("已提交").addClass("submitted")}else{s.nodes.$loading.css("opacity",0).addClass("hidden");s.showToast(e&&e.msg||"提交失败！")}},error:function(e){s.nodes.$loading.css("opacity",0).addClass("hidden");s.showToast("提交失败！")}})}else{s.nodes.$loading.css("opacity",0).addClass("hidden");s.showToast("获取用户信息失败！")}},showToast:function(e,s){var t=this;t.nodes.$toash.html(e).removeClass("hidden").css("opacity",1);setTimeout(function(){t.nodes.$toash.html(e).css("opacity",0).addClass("hidden")},s||3e3)},events:function(){var t=this;t.nodes.$fileImage[0].addEventListener("change",function(e){e.target.files.length&&(t.file=e.target.files[0]);if(t.file.size<614400){t.showToast("文件大小不能小于600KB！");t.file=null}else if(t.file.type.indexOf("jpeg")<0&&t.file.type.indexOf("jpg")<0){t.showToast("图片格式必须为.jpg后缀！");t.file=null}else{t.nodes.$loading.removeClass("hidden").css("opacity",1).find(".text").text("正在上传...");t.ajax({type:"post",url:"/upload/post_file?user="+t.userInfo.tys_user+"&expired="+t.userInfo.tys_expired+"&sign="+t.userInfo.tys_sign,contentType:"multipart/form-data",data:{headImg:t.file},success:function(e){t.nodes.$loading.css("opacity",0).addClass("hidden");if(e.code==0){var s=t.basePath+"/download/30years/"+e.data.imgUrl;t.nodes.$avatar.addClass("selected").css({"background-image":"url("+s+")"});t.nodes.$submit.text("提交").removeClass("submitted")}else{t.showToast(e.msg||"图片上传失败！")}},error:function(e){t.nodes.$loading.css("opacity",0).addClass("hidden");t.showToast("图片上传失败！")}})}});this.nodes.$submit[0].addEventListener("touchend",function(e){t.size="";t.sizeDesc="";if(t.nodes.$clothes.children("li.selected").length){t.size=t.nodes.$clothes.children("li.selected").text();t.sizeDesc=""}else{t.sizeDesc=t.nodes.$clothes.find(".size-input").val().trim();t.size=""}if(!t.hasComAuth){t.showToast("非常抱歉，您不能参加此活动。",3e3)}else if($(this).hasClass("submitted")){t.showToast("您已经提交过了！")}else if(!t.file&&!t.avatarUrl){t.showToast("请先上传照片！")}else if(!t.size&&!t.sizeDesc){t.showToast("请选择服装尺码！")}else{t.nodes.$loading.removeClass("hidden").css("opacity",1).find(".text").text("提交中...");t.commitTimer&&clearTimeout(t.commitTimer);t.commitTimer=setTimeout(function(){t.submit()},2e3)}});this.nodes.$clothes[0].addEventListener("touchend",function(e){if(e.target.nodeName==="LI"){if($(e.target).hasClass("selected")){$(e.target).removeClass("selected")}else{$(e.target).addClass("selected").siblings().removeClass("selected")}}else if(e.target.nodeName==="INPUT"){$(e.target).parent().siblings().removeClass("selected")}t.nodes.$submit.text("提交").removeClass("submitted")});this.nodes.$clear[0].addEventListener("touchend",function(e){t.nodes.$clothes.find(".size-input").val("")});this.nodes.$sizeInput.focus(function(e){$(this).siblings(".clear").removeClass("hidden")});this.nodes.$sizeInput.blur(function(e){$(this).siblings(".clear").addClass("hidden")})}};new s(e).init()})();